{% extends "base.html" %}

{% block content %}
<div id="page-body" class="page-body mx-auto max-w-6xl space-y-8">
    <section id="intro-section" class="section intro-section bg-white border border-slate-200 rounded-lg px-6 py-5 md:px-8 md:py-6">
        <div id="intro-inner" class="intro-inner flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div id="intro-copy" class="intro-copy space-y-2">
                <p class="text-xs font-semibold uppercase tracking-[0.18em] text-emerald-700">Arca.live Backup</p>
                <h1 class="text-2xl font-bold text-slate-900">채널 글 + 이미지 백업</h1>
                <p class="text-sm text-slate-600 max-w-2xl">게시글 JSON과 오프라인 HTML(이미지 Data URL 내장)을 생성합니다.</p>
            </div>
            <div id="intro-meta" class="intro-meta rounded-lg border border-slate-200 bg-slate-50 px-4 py-3">
                <p class="text-xs font-semibold text-slate-600">백업 루트</p>
                <p id="backup-root-text" class="mt-1 font-mono text-xs text-slate-700 truncate max-w-xs">{{ backup_root }}</p>
            </div>
        </div>
    </section>

    <section id="form-section" class="section form-section grid gap-6">
        <article id="config-card" class="config-card bg-white border border-slate-200 rounded-lg px-6 py-5 md:px-7 md:py-6" x-data='{"outName": "", "root": {{ backup_root|tojson }} }'>
            <div id="config-header" class="config-header mb-4 flex items-start justify-between gap-3">
                <div>
                    <p class="text-xs font-semibold text-emerald-700 uppercase tracking-[0.2em]">Crawler 설정</p>
                    <h2 class="text-lg font-bold text-slate-900 leading-tight mt-1">채널 옵션</h2>
                </div>
            </div>
            <form id="backup-form" class="backup-form space-y-4" hx-post="/backup/run" hx-target="#run-result" hx-swap="innerHTML" hx-indicator="#run-indicator">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <label class="flex flex-col gap-1 text-sm text-slate-700" for="input-channel">
                        <span class="font-semibold">채널 ID</span>
                        <input id="input-channel" name="channel" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-600 focus:ring-2 focus:ring-emerald-200" value="" placeholder="예: 3d3d" required>
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-700" for="input-category">
                        <span class="font-semibold">카테고리</span>
                        <input id="input-category" name="category" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-600 focus:ring-2 focus:ring-emerald-200" value="" placeholder="미입력=전체 (예: 전체)">
                        <span class="text-xs text-slate-500">채널에 없는 카테고리를 넣으면 글이 없을 수 있습니다.</span>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <label class="flex flex-col gap-1 text-sm text-slate-700" for="input-start-page">
                        <span class="font-semibold">시작 페이지</span>
                        <input id="input-start-page" name="start_page" type="number" min="1" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-600 focus:ring-2 focus:ring-emerald-200" value="" required>
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-700" for="input-end-page">
                        <span class="font-semibold">마지막 페이지</span>
                        <input id="input-end-page" name="end_page" type="number" min="1" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-600 focus:ring-2 focus:ring-emerald-200" value="" required>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <label class="flex flex-col gap-1 text-sm text-slate-700" for="input-sleep">
                        <span class="font-semibold">요청 간 대기(초)</span>
                        <input id="input-sleep" name="sleep" type="number" min="0" step="0.1" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-600 focus:ring-2 focus:ring-emerald-200" value="0.8">
                        <span class="text-xs text-slate-500">짧게 줄이면 속도↑, 너무 낮으면 차단 위험</span>
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-700" for="input-out-name">
                        <span class="font-semibold">출력 폴더명</span>
                        <input id="input-out-name" name="out_name" type="text" x-model="outName" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-600 focus:ring-2 focus:ring-emerald-200" value="" placeholder="지정하지 않으면 채널/카테고리 기반으로 생성">
                        <span class="text-xs text-slate-500">풀 경로: <span class="font-mono text-emerald-700" x-text="`${root}/${outName || '...'}`"></span></span>
                    </label>
                </div>

                <div class="flex items-center justify-between gap-3 pt-2">
                    <button id="submit-button" type="submit" hx-disable="true" class="inline-flex items-center gap-2 rounded-md bg-emerald-700 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-700">
                        <span>백업 시작</span>
                        <span aria-hidden="true">→</span>
                    </button>
                </div>
            </form>

            <section id="result-panel" class="result-panel mt-6 rounded-lg border border-slate-200 bg-white">
                <div id="result-header" class="result-header flex items-center justify-between border-b border-slate-200 px-4 py-3">
                    <div>
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-[0.2em]">Result</p>
                        <h3 class="text-base font-bold text-slate-900">실행 결과</h3>
                    </div>
                </div>
                <div id="run-result" class="run-result px-4 py-4 text-sm text-slate-700">
                    <div id="run-result-placeholder" class="rounded-md border border-dashed border-slate-200 bg-slate-50 px-4 py-4">
                        <p>옵션을 입력하고 "백업 시작"을 누르면 이 영역이 결과로 갱신됩니다.</p>
                    </div>
                </div>
                <div id="run-indicator" class="run-indicator htmx-indicator hidden border-t border-slate-200 px-4 py-3 text-sm text-emerald-700 bg-emerald-50">
                    <div class="flex items-center gap-2">
                        <div class="h-3 w-3 rounded-full border-2 border-emerald-500 border-t-transparent animate-spin"></div>
                        <span>작업 중입니다...</span>
                    </div>
                </div>
            </section>
        </article>
    </section>

    <section id="history-section" class="section history-section bg-white border border-slate-200 rounded-lg px-6 py-5 md:px-8 md:py-6">
        <div id="history-header" class="history-header mb-4 flex items-center justify-between">
            <div>
                <p class="text-xs font-semibold text-emerald-700 uppercase tracking-[0.2em]">Backups</p>
                <h2 class="text-xl font-bold text-slate-900 leading-tight">최근 백업 목록</h2>
            </div>
            <span class="text-xs text-slate-500">최신 수정 순</span>
        </div>
        <form id="history-filter-form" class="history-filter-form mb-4 flex flex-col gap-3 md:flex-row md:items-end md:justify-between" hx-get="/backups/list" hx-target="#run-history" hx-swap="innerHTML">
            <div id="history-filter-fields" class="history-filter-fields flex flex-col gap-3 md:flex-row md:items-end">
                <label class="flex flex-col gap-1 text-sm text-slate-700" for="filter-channel">
                    <span class="text-xs font-semibold text-slate-600 uppercase tracking-[0.16em]">채널</span>
                    <input id="filter-channel" name="channel" type="text" list="filter-channel-options" class="w-full md:w-40 rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-600 focus:ring-2 focus:ring-emerald-200" placeholder="전체">
                </label>
                <label class="flex flex-col gap-1 text-sm text-slate-700" for="filter-category">
                    <span class="text-xs font-semibold text-slate-600 uppercase tracking-[0.16em]">카테고리</span>
                    <input id="filter-category" name="category" type="text" list="filter-category-options" class="w-full md:w-48 rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-600 focus:ring-2 focus:ring-emerald-200" placeholder="전체">
                </label>
            </div>
            <div id="history-filter-actions" class="history-filter-actions flex items-center gap-2">
                <button id="filter-submit" type="submit" class="inline-flex items-center justify-center rounded-md border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                    조회
                </button>
                <button id="filter-reset" type="reset" hx-get="/backups/list" hx-target="#run-history" hx-swap="innerHTML" hx-params="none" class="inline-flex items-center justify-center rounded-md border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">
                    전체
                </button>
            </div>
        </form>
        <datalist id="filter-channel-options">
            {% for channel in channels %}
                <option value="{{ channel }}"></option>
            {% endfor %}
        </datalist>
        <datalist id="filter-category-options">
            {% for category in categories %}
                <option value="{{ category }}"></option>
            {% endfor %}
        </datalist>
        <div id="run-history" class="run-history rounded-lg border border-slate-200 overflow-hidden">
            {% include 'partials/run_list.html' %}
        </div>
    </section>
</div>
{% endblock %}
